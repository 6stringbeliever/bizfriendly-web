<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>routes.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>routes.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">make_response</span>
<span class="kn">from</span> <span class="nn">bizfriendly</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">boto</span><span class="o">,</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">boto.s3.key</span> <span class="kn">import</span> <span class="n">Key</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Helper Functions --------------------------------------------------------</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Traverses a path into a json object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_data_on_attribute_path</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">attributes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="n">attribute</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json_data</span> <span class="c"># Should be a string or int now, not json</span>
    <span class="k">return</span> <span class="n">data</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Convert to a python boolean</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">boolify</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;false&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;huh?&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Convert string to a boolean, int, float, or list</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">autoconvert</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">(</span><span class="n">boolify</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
    <span class="k">return</span> <span class="n">s</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Routes --------------------------------------------------------</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/check_for_new&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_for_new</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Check once for original count of objects
then check if new object exists
Remember new object
Return desired endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;attribute_to_display&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_to_remember&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;new_object_added&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;original_count&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;timeout&quot;</span> <span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Require Authorization header for this endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Authorization required&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    
    <span class="n">third_party_service</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;thirdPartyService&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">third_party_service</span> <span class="o">==</span> <span class="s">&#39;facebook&#39;</span><span class="p">:</span>
            <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;attribute_to_display&quot;</span> <span class="p">:</span> <span class="s">&quot;TEST PAGE&quot;</span><span class="p">,</span>
                <span class="s">&quot;attribute_to_remember&quot;</span> <span class="p">:</span> <span class="mi">297429370396923</span><span class="p">,</span>
                <span class="s">&quot;new_object_added&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s">&quot;original_count&quot;</span> <span class="p">:</span> <span class="mi">10000000</span><span class="p">,</span>
                <span class="s">&quot;timeout&quot;</span> <span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">third_party_service</span> <span class="o">==</span> <span class="s">&#39;trello&#39;</span><span class="p">:</span>
            <span class="n">step_number</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[stepNumber]&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">step_number</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&quot;attribute_to_display&quot;</span> <span class="p">:</span> <span class="s">&quot;BizFriendly Test Board&quot;</span><span class="p">,</span>
                    <span class="s">&quot;attribute_to_remember&quot;</span> <span class="p">:</span> <span class="s">&quot;52279d81c2fc68175a000609&quot;</span><span class="p">,</span>
                    <span class="s">&quot;new_object_added&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">&quot;original_count&quot;</span> <span class="p">:</span> <span class="mi">10000000</span><span class="p">,</span>
                    <span class="s">&quot;timeout&quot;</span> <span class="p">:</span> <span class="bp">False</span>
                <span class="p">}</span>

    <span class="n">resource_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerEndpoint]&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;rememberedAttribute&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">remembered_attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;rememberedAttribute&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resource_url</span> <span class="o">=</span> <span class="n">resource_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;replace_me&#39;</span><span class="p">,</span><span class="n">remembered_attribute</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Check if a triggerCheck has been set.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">path_for_objects</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]:</span>
        <span class="n">path_for_objects</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">path_for_attribute_to_display</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerValue]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">path_for_attribute_to_remember</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[thingToRemember]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">place_in_collection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[placeInCollection]&#39;</span><span class="p">]</span>
    <span class="n">original_count</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;originalCount&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>If original_count is false in post data, then just return the count of objects at the endpoint.
original_count can be 0 so check not int instead of False</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">original_count</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>r = current_user.make_authorized_request(service_name, trigger_endpoint)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">resource</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">path_for_objects</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path_for_objects</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
                    <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;original_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_count</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Check api_resource_url every two seconds for a new addition at path_of_resource_to_check</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">timer</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">:</span> <span class="c"># Heroku has a timeout of 30 seconds.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">path_for_objects</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path_for_objects</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
                    <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">original_count</span><span class="p">:</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;new_object_added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;new_object_added&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span> <span class="c"># timeout</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Facebook pages are added to the end of the list.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">place_in_collection</span> <span class="o">==</span> <span class="s">&#39;last&#39;</span><span class="p">:</span>
        <span class="n">the_new_resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Foursquare has new tips as the first in the list.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">place_in_collection</span> <span class="o">==</span> <span class="s">&#39;first&#39;</span><span class="p">:</span>
        <span class="n">the_new_resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Foursquare lists have the new list second, after the default to do list.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">place_in_collection</span> <span class="o">==</span> <span class="s">&#39;second&#39;</span><span class="p">:</span>
        <span class="n">the_new_resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">place_in_collection</span> <span class="o">==</span> <span class="s">&#39;alphabetical&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">third_party_service</span> <span class="o">==</span> <span class="s">&quot;trello&quot;</span><span class="p">:</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">board</span> <span class="p">:</span> <span class="n">board</span><span class="p">[</span><span class="s">&quot;dateLastView&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">the_new_resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Return an attribute to display if its not blank.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">path_for_attribute_to_display</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_to_display&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">the_new_resource</span><span class="p">,</span> <span class="n">path_for_attribute_to_display</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Remember an attribute of the new resource if its not blank.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">path_for_attribute_to_remember</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_to_remember&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">the_new_resource</span><span class="p">,</span> <span class="n">path_for_attribute_to_remember</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/check_if_attribute_exists&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_if_attribute_exists</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Check if attribute exists
Return attribute</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;attribute_exists&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_to_display&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;timeout&quot;</span> <span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Require Authorization header for this endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Authorization required&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">third_party_service</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;thirdPartyService&#39;</span><span class="p">]</span>
    <span class="n">resource_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerEndpoint]&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;rememberedAttribute&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">remembered_attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;rememberedAttribute&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resource_url</span> <span class="o">=</span> <span class="n">resource_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;replace_me&#39;</span><span class="p">,</span><span class="n">remembered_attribute</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">path_for_attribute_to_display</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Check api_resource_url every two seconds for a value</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">timer</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># If empty list, it doesn&#39;t exist</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path_for_attribute_to_display</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># key doesn&#39;t exist</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>If resource is still a dict, we didn't find what we were looking for.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_exists&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_to_display&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/check_attribute_for_value&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_attribute_for_value</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Check attribute for value
If it matches, return other attribute</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;attribute_value_matches&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_to_display&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;timeout&quot;</span> <span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Require Authorization header for this endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Authorization required&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">third_party_service</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;thirdPartyService&#39;</span><span class="p">]</span>
    <span class="n">resource_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerEndpoint]&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;rememberedAttribute&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">remembered_attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;rememberedAttribute&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resource_url</span> <span class="o">=</span> <span class="n">resource_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;replace_me&#39;</span><span class="p">,</span><span class="n">remembered_attribute</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">trigger_checks</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">trigger_value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerValue]&#39;</span><span class="p">]</span>
    <span class="n">path_for_attribute_to_display</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[thingToRemember]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

    <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">timer</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">trigger_check</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">trigger_checks</span><span class="p">)</span>
        <span class="n">trigger_value</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">trigger_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trigger_check</span> <span class="o">==</span> <span class="n">trigger_value</span><span class="p">:</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_value_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_to_display&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span><span class="n">path_for_attribute_to_display</span><span class="p">)</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/check_attribute_for_update&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_attribute_for_update</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Check once for original_value of attribute
then check if attribute value has changed
Return that endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Require Authorization header for this endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Authorization required&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span>

    <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;original_attribute_value&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_value_updated&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_to_display&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>"attribute_to_remember" : False,</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="s">&quot;timeout&quot;</span> <span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">third_party_service</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;thirdPartyService&#39;</span><span class="p">]</span>
    <span class="n">resource_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerEndpoint]&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;rememberedAttribute&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">remembered_attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;rememberedAttribute&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resource_url</span> <span class="o">=</span> <span class="n">resource_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;replace_me&#39;</span><span class="p">,</span><span class="n">remembered_attribute</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">path_for_attribute_to_check</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>trigger_value = request.form['currentStep[triggerValue]']
Dispaly same column we were checking</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">path_for_attribute_to_display</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>path_for_attribute_to_remember = request.form['currentStep[thingToRemember]'].split(',')</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">original_attribute_values</span> <span class="o">=</span> <span class="n">autoconvert</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;originalAttributeValues&#39;</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_attribute_values</span><span class="p">:</span>
        <span class="n">original_attribute_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">path_for_attribute_to_check</span><span class="p">)</span>
            <span class="n">original_attribute_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;original_attribute_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_attribute_values</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span>

    <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">timer</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">current_attribute_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">current_attribute_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">path_for_attribute_to_check</span><span class="p">))</span>
        <span class="n">updated_value</span> <span class="o">=</span> <span class="n">current_attribute_values</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">original_attribute_values</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>for resource in resources:
    if updated_value == resource["name"]:
        updated_value_id = resource["id"]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated_value</span><span class="p">):</span>
            <span class="n">updated_value</span> <span class="o">=</span> <span class="n">updated_value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_value_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_to_display&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_value</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>our_response["attribute_to_remember"] = updated_value_id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/get_attributes&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_attributes</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Get the attributes from the resource_url
If remembered_attributes exists, use that as the id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">our_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;attribute&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_2&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;attribute_3&quot;</span> <span class="p">:</span> <span class="bp">False</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Require Authorization header for this endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Authorization required&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">third_party_service</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;thirdPartyService&#39;</span><span class="p">]</span>
    <span class="n">resource_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerEndpoint]&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;rememberedAttribute&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">remembered_attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;rememberedAttribute&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resource_url</span> <span class="o">=</span> <span class="n">resource_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;replace_me&#39;</span><span class="p">,</span><span class="n">remembered_attribute</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">path_for_attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerCheck]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">path_for_attribute_2</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[triggerValue]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">path_for_attribute_3</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStep[thingToRemember]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">make_authorized_request</span><span class="p">(</span><span class="n">third_party_service</span><span class="p">,</span> <span class="n">resource_url</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">path_for_attribute</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">path_for_attribute_2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">our_response</span><span class="p">[</span><span class="s">&quot;attribute_3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_on_attribute_path</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">path_for_attribute_3</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">our_response</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/signup&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">htc_signup</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>If request is from ie9, the info comes in raw.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">ie9_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%40&#39;</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;name=(.*)&amp;email=(.+)&amp;password=(.+)&quot;</span><span class="p">,</span> <span class="n">ie9_data</span><span class="p">)</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">user_email</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">user_password</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>All other browsers post as a form </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">user_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">user_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Validate emails</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[a-zA-Z0-9_.+-]+\@[a-zA-Z0-9-]+\.+[a-zA-Z0-9]{2,4}$&quot;</span><span class="p">,</span> <span class="n">user_email</span><span class="p">):</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;That email doesn</span><span class="se">\&#39;</span><span class="s">t look right.&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">user_password</span><span class="p">,</span> <span class="n">user_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">user_email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()):</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Someone has already signed up with that email.&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>        
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>EMail the new user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;Welcome to BizFriend.ly&quot;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;h3&gt;Thanks for joining, &lt;a href=&quot;http://bizfriend.ly&quot;&gt;BizFriend.ly&lt;/a&gt;!&lt;/h3&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;p&gt;We</span><span class="se">\&#39;</span><span class="s">re a community of entrepreneurial learners and teachers who share the latest digital skills and web services to run your business.&lt;/p&gt;&#39;</span> 
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Now that you have an account, there&#39;s a few things you can do:&lt;/p&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;ul&gt;&lt;li&gt;Start Learning! Try out a few lessons at &lt;a href=&quot;http://bizfriend.ly/learn.html&quot;&gt;http://bizfriend.ly/learn.html&lt;/a&gt;&lt;/li&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;li&gt;Start Teaching! Teach other business owners the skills you</span><span class="se">\&#39;</span><span class="s">re best at &lt;a href=&quot;http://bizfriend.ly/teach.html&quot;&gt;http://bizfriend.ly/teach.html&lt;/a&gt;&lt;/li&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;li&gt;See all what other businesses are up to and track your accomplishments &lt;a href=</span><span class="se">\&quot;</span><span class="s">http://bizfriend.ly/connect.html</span><span class="se">\&quot;</span><span class="s">&gt;http://bizfriend.ly/connect.html&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;We&#39;d love to hear any feedback you have at &lt;a href=</span><span class="se">\&quot;</span><span class="s">http://bit.ly/1bS1yEQ</span><span class="se">\&quot;</span><span class="s">&gt;http://bit.ly/1bS1yEQ&lt;/a&gt; and feel free to email us with any questions!&lt;/p&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&#39;&#39;Andew &amp; Ariel&lt;br/&gt;</span>
<span class="s">               Co-Founders of &lt;a href=&quot;http://bizfriend.ly&quot;&gt;BizFriend.ly&lt;/a&gt;&lt;br/&gt;</span>
<span class="s">               2013 Code for America Fellows&lt;br/&gt;</span>
<span class="s">               &lt;a href=&quot;mailto:kansascity@codeforamerica.org&quot;&gt;kansascity@codeforamerica.org&lt;/a&gt;</span>
<span class="s">            &#39;&#39;&#39;</span>

    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s">&quot;https://api.mailgun.net/v2/app14961102.mailgun.org/messages&quot;</span><span class="p">,</span>
        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;MAIL_GUN_KEY&#39;</span><span class="p">]),</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;from&quot;</span><span class="p">:</span> <span class="s">&quot;Andrew Hyder &lt;andrewh@codeforamerica.org&gt;&quot;</span><span class="p">,</span>
              <span class="s">&quot;to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">user_email</span><span class="p">],</span>
              <span class="s">&quot;cc&quot;</span><span class="p">:</span> <span class="s">&quot;Kansas City &lt;kansascity@codeforamerica.org&gt;&quot;</span><span class="p">,</span>
              <span class="s">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
              <span class="s">&quot;html&quot;</span><span class="p">:</span> <span class="n">html</span><span class="p">})</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">user_email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;access_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span> 
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Return a proper response with correct headers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/signin&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">htc_signin</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>If request is from ie9, the info comes in raw.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">ie9_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%40&#39;</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;email=(.+)&amp;password=(.+)&quot;</span><span class="p">,</span> <span class="n">ie9_data</span><span class="p">)</span>
        <span class="n">user_email</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">user_password</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>All other browsers post as a form </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">user_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">user_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Validate emails</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[a-zA-Z0-9_.+-]+\@[a-zA-Z0-9-]+\.+[a-zA-Z0-9]{2,4}$&quot;</span><span class="p">,</span> <span class="n">user_email</span><span class="p">):</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;That email doesn</span><span class="se">\&#39;</span><span class="s">t look right.&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">user_email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">current_user</span> <span class="ow">and</span> <span class="n">current_user</span><span class="o">.</span><span class="n">check_pw</span><span class="p">(</span><span class="n">user_password</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>User is valid, return credentials</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">response</span><span class="p">[</span><span class="s">&#39;access_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;token_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bearer&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Couldn&#39;t find your email and password.&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="mi">401</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/create_connection&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_connection</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;connection_saved&quot;</span> <span class="p">:</span> <span class="bp">False</span>
    <span class="p">}</span>

    <span class="n">service_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;service&#39;</span><span class="p">]</span>
    <span class="n">oauth_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;service_access&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Require Authorization header for this endpoint</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Authorization required&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;User not found&#39;</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>Update exisitng connection with new oauth token</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">connectionUpdatedFlag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">service</span> <span class="o">==</span> <span class="n">service_name</span><span class="p">:</span>
            <span class="n">connectionUpdatedFlag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">oauth_token</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Make a new connection if there isnt one</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">connectionUpdatedFlag</span><span class="p">:</span>
        <span class="n">new_connection</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">oauth_token</span><span class="p">)</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_connection</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;connection_saved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/record_step&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">record_step</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>If request is from ie9, the info comes in raw.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;currentStepId=(.+)&amp;currentLessonId=(.+)&amp;auth=(.*)&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">current_step_id</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">current_lesson_id</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
        <span class="n">current_lesson_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentLessonId&#39;</span><span class="p">]</span>
        <span class="n">current_step_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;currentStepId&#39;</span><span class="p">]</span>
        <span class="n">htc_access</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Get user, lesson, step</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">access_token</span><span class="o">=</span><span class="n">htc_access</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">current_lesson</span> <span class="o">=</span> <span class="n">Lesson</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">current_lesson_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">current_step</span> <span class="o">=</span> <span class="n">Step</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">current_step_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>If already started the lesson, just alter recent step</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">user_lesson</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">lessons_completed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_lesson</span><span class="o">.</span><span class="n">lesson_id</span> <span class="o">==</span> <span class="n">current_lesson</span><span class="o">.</span><span class="n">id</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Save the farthest step they get to.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">current_step</span><span class="o">.</span><span class="n">step_number</span> <span class="o">&gt;</span> <span class="n">user_lesson</span><span class="o">.</span><span class="n">recent_step_number</span><span class="p">:</span>
                <span class="n">user_lesson</span><span class="o">.</span><span class="n">recent_step_number</span> <span class="o">=</span> <span class="n">current_step</span><span class="o">.</span><span class="n">step_number</span>
                <span class="n">user_lesson</span><span class="o">.</span><span class="n">recent_step_id</span> <span class="o">=</span> <span class="n">current_step</span><span class="o">.</span><span class="n">id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>If final step in lesson, update end_dt</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">step_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">step</span><span class="o">.</span><span class="n">step_number</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">current_lesson</span><span class="o">.</span><span class="n">steps</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">current_step</span><span class="o">.</span><span class="n">step_number</span> <span class="o">==</span> <span class="n">step_count</span><span class="p">:</span>
                <span class="n">user_lesson</span><span class="o">.</span><span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">user_lesson</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">response</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;New step recorded.&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
            <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>New to the lesson, append it to user lesson association</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">current_user</span> <span class="ow">and</span> <span class="n">current_lesson</span><span class="p">:</span>
        <span class="n">user_lesson</span> <span class="o">=</span> <span class="n">UserLesson</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">current_lesson</span><span class="o">.</span><span class="n">recent_step_id</span> <span class="o">=</span> <span class="n">current_step</span><span class="o">.</span><span class="n">id</span>
        <span class="n">current_lesson</span><span class="o">.</span><span class="n">recent_step_number</span> <span class="o">=</span> <span class="n">current_step</span><span class="o">.</span><span class="n">step_number</span>
        <span class="n">user_lesson</span><span class="o">.</span><span class="n">lesson</span> <span class="o">=</span> <span class="n">current_lesson</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">lessons_completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_lesson</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;New lesson and step recorded.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unable to save lesson state.&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/third_party_services&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">third_party_services</span><span class="p">():</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;bizfriendly/static&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>third_party_service_resources = []</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">json_data</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;bizfriendly/static/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/image_upload&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">image_upload</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;tmp&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;files[]&#39;</span><span class="p">]</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;tmp&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <h1>Check image size</h1>
<p>img = Image.open("tmp/"+file.filename)</p>
<h1>get the image's width and height in pixels</h1>
<p>width, height = img.size
if width &gt; 260:
    response = {}
    response["message"] = "Image too wide."
    return make_response(json.dumps(response), 401)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">conn</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">connect_s3</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="p">],</span> <span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="p">])</span>
    <span class="n">mybucket</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;S3_BUCKET_NAME&#39;</span><span class="p">])</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">mybucket</span><span class="p">)</span>
    <span class="n">k</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span>
    <span class="n">k</span><span class="o">.</span><span class="n">set_contents_from_filename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;tmp&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">mybucket</span><span class="o">.</span><span class="n">set_acl</span><span class="p">(</span><span class="s">&#39;public-read&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">return_json</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="s">&quot;size&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&#39;tmp/&#39;</span><span class="o">+</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
        <span class="s">&quot;url&quot;</span><span class="p">:</span> <span class="s">&quot;https://</span><span class="si">%s</span><span class="s">.s3.amazonaws.com/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;S3_BUCKET_NAME&#39;</span><span class="p">],</span> <span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&quot;files&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">return_json</span><span class="p">]})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/request_password_reset&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">request_password_reset</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>Validate emails</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[a-zA-Z0-9_.+-]+\@[a-zA-Z0-9-]+\.+[a-zA-Z0-9]{2,4}$&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;That email doesn</span><span class="se">\&#39;</span><span class="s">t look right.&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>Get that user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Couldn&#39;t find your email and password.&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100000000</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;Reset BizFriendly Password&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Want to change your BizFriend.ly password?&quot;</span>
    <span class="n">text</span> <span class="o">+=</span> <span class="s">&quot;http://bizfriend.ly/reset-password.html?&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s">&quot;https://api.mailgun.net/v2/app14961102.mailgun.org/messages&quot;</span><span class="p">,</span>
        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;MAIL_GUN_KEY&#39;</span><span class="p">]),</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;from&quot;</span><span class="p">:</span> <span class="s">&quot;Andrew Hyder &lt;andrewh@codeforamerica.org&gt;&quot;</span><span class="p">,</span>
              <span class="s">&quot;to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">email</span><span class="p">],</span>
              <span class="s">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
              <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/password_reset&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">password_reset</span><span class="p">():</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">reset_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;resetToken&#39;</span><span class="p">]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>Validate emails</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^[a-zA-Z0-9_.+-]+\@[a-zA-Z0-9-]+\.+[a-zA-Z0-9]{2,4}$&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;That email doesn</span><span class="se">\&#39;</span><span class="s">t look right.&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
        <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Reset password</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Couldn&#39;t find your email and password.&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">reset_token</span><span class="p">):</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">pw_digest</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">response</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Password reset&quot;</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/.well-known/status&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">status</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;ok&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>Check DB</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_category</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Database is unavailable&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>Timestamp</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">response</span><span class="p">[</span><span class="s">&quot;updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;S3&quot;</span><span class="p">,</span> <span class="s">&quot;Mailgun&quot;</span><span class="p">]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/new_content_email&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">new_content_email</span><span class="p">():</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
    <span class="n">new_content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;creator_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&quot;category_id&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;category_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">Service</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&quot;service_id&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">Service</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;service_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">service</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;New &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;state&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; content Added to BizFriend.ly&quot;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="s">&quot;&lt;p&gt;Name: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;category_id&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;p&gt;Service Link: &lt;a href=&quot;http://bizfriend.ly/service.html?&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&quot;&gt;http://bizfriend.ly/service.html?&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&lt;/p&gt;&#39;</span>
    <span class="k">if</span> <span class="s">&quot;service_id&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;p&gt;Lesson Link: &lt;a href=&quot;http://bizfriend.ly/instructions.html?&#39;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&quot;&gt;http://bizfriend.ly/instructions.html?&#39;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&lt;/p&gt;&#39;</span>
    <span class="k">if</span> <span class="s">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Url: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;url&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Description: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;short_description&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Short Descrption: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;short_description&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;long_description&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Long Descrption: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;long_description&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;additional_resources&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Additional Resources: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;additional_resources&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;tips&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Tips: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;tips&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;icon&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Icon: &lt;img src=&quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;icon&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&gt;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;media&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Media: &quot;</span><span class="o">+</span><span class="n">new_content</span><span class="p">[</span><span class="s">&quot;media&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;category_id&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Skill: &quot;</span><span class="o">+</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;service_id&quot;</span> <span class="ow">in</span> <span class="n">new_content</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Skill: &quot;</span><span class="o">+</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Service: &quot;</span><span class="o">+</span><span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>

    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;Created by: &quot;</span><span class="o">+</span><span class="n">creator</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">+</span><span class="n">creator</span><span class="o">.</span><span class="n">email</span><span class="o">+</span><span class="s">&quot;&lt;/p&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;br&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;p&gt;You&#39;re getting this email because you are an Admin for BizFriend.ly&lt;/p&gt;&quot;</span>
    <span class="k">for</span> <span class="n">admin</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>Production app14961102.mailgun.org
Staging app17090450.mailgun.org</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="s">&quot;https://api.mailgun.net/v2/app14961102.mailgun.org/messages&quot;</span><span class="p">,</span>
            <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;api&quot;</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;MAIL_GUN_KEY&#39;</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;from&quot;</span><span class="p">:</span> <span class="s">&quot;Andrew Hyder &lt;andrewh@codeforamerica.org&gt;&quot;</span><span class="p">,</span>
                  <span class="s">&quot;to&quot;</span><span class="p">:</span> <span class="n">admin</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                  <span class="s">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
                  <span class="s">&quot;html&quot;</span><span class="p">:</span> <span class="n">html</span><span class="p">})</span>
        <span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&lt;user_id&gt;/is_admin&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">Bf_user</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">&quot;admin&quot;</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
